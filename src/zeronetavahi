#!/bin/bash
#
# .---.                  .              .
# |                      |              |
# |--- .--. .-.  .-.  .-.|  .-. .--.--. |.-.  .-. .--.  .-.
# |    |   (.-' (.-' (   | (   )|  |  | |   )(   )|  | (.-'
# '    '     --'  --'  -' -  -' '  '   -' -'   -' '   -  --'
#
#                    Freedom in the Cloud
#
# A script for using avahi to discover peers and update zeronet trackers

# License
# =======
#
# Copyright (C) 2015 Bob Mottram <bob@robotics.uk.to>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

TRACKER_PORT=51413
BOOTSTRAP_FILE=/opt/zeronet/bootstrap

if [ ! -d /opt/zeronet ]; then
    if [ -d ~/zeronet ]; then
        BOOTSTRAP_FILE=~/zeronet/bootstrap
    else
        exit 0
    fi
fi

if [ ! -d /etc/avahi ]; then
    exit 0
fi

TEMPFILE=/tmp/tmpzeronetavahi.txt
avahi-browse -atr | grep "Workstation\|hostname =\|address =\|port =" > $TEMPFILE
if [ ! -f $TEMPFILE ]; then
    exit 1
fi

state=0
address=""
peer=""
while IFS='' read -r line || [[ -n "$line" ]]; do
    if [ ${state} -eq "2" ]; then
        if [[ $line == *"address ="* ]]; then
            address=$(echo $line | awk -F '[' '{print $2}' | awk -F ']' '{print $1}')
            echo "udp $address $TRACKER_PORT" >> $BOOTSTRAP_FILE.new
            state=0
        fi
    fi
    if [ ${state} -eq "1" ]; then
        if [[ $line == *"hostname ="* ]]; then
            peer=$(echo $line | awk -F '[' '{print $2}' | awk -F ']' '{print $1}')
            state=2
        fi
    fi
    if [[ $line == *"Workstation"* && $line == "= "* ]]; then
        state=1
    fi
done < "$TEMPFILE"

rm -f $TEMPFILE
cp -f $BOOTSTRAP_FILE.new $BOOTSTRAP_FILE
rm -f $BOOTSTRAP_FILE.new
sudo chown zeronet:zeronet $BOOTSTRAP_FILE

exit 0
