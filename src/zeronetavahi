#!/bin/bash
#
# .---.                  .              .
# |                      |              |
# |--- .--. .-.  .-.  .-.|  .-. .--.--. |.-.  .-. .--.  .-.
# |    |   (.-' (.-' (   | (   )|  |  | |   )(   )|  | (.-'
# '    '     --'  --'  -' -  -' '  '   -' -'   -' '   -  --'
#
#                    Freedom in the Cloud
#
# A script for using avahi to discover peers and update zeronet trackers

# License
# =======
#
# Copyright (C) 2015 Bob Mottram <bob@robotics.uk.to>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

TRACKER_PORT=6969
BOOTSTRAP_FILE=/opt/zeronet/bootstrap
BLOGS_FILE=/opt/zeronet/blogs
FORUM_FILE=/opt/zeronet/forum

if [ ! -d /opt/zeronet ]; then
    if [ -d ~/zeronet ]; then
        BOOTSTRAP_FILE=~/zeronet/bootstrap
        BLOGS_FILE=~/zeronet/blogs
        FORUM_FILE=~/zeronet/forum
    else
        exit 0
    fi
fi

if [ ! -d /etc/avahi ]; then
    exit 0
fi

TEMPFILE_BASE=/tmp/tmpzeronetavahibase.txt
TEMPFILE=/tmp/tmpzeronetavahi.txt
avahi-browse -atr > $TEMPFILE_BASE
cat $TEMPFILE_BASE | grep "Workstation\|hostname =\|address =\|port =" > $TEMPFILE
if [ ! -f $TEMPFILE ]; then
    exit 1
fi

if [ -f $BOOTSTRAP_FILE.new ]; then
    rm -f $BOOTSTRAP_FILE.new
fi

state=0
address=""
peer=""
while IFS='' read -r line || [[ -n "$line" ]]; do
    if [ ${state} -eq "2" ]; then
        if [[ $line == *"address ="* ]]; then
            address=$(echo $line | awk -F '[' '{print $2}' | awk -F ']' '{print $1}')
            echo "http $peer:$TRACKER_PORT/announce None" >> $BOOTSTRAP_FILE.new
            state=0
        fi
    fi
    if [ ${state} -eq "1" ]; then
        if [[ $line == *"hostname ="* ]]; then
            peer=$(echo $line | awk -F '[' '{print $2}' | awk -F ']' '{print $1}')
            state=2
        fi
    fi
    if [[ $line == *"Workstation"* && $line == "= "* ]]; then
        state=1
    fi
done < "$TEMPFILE"

# detect blogs in the mesh
if [ -f $BLOGS_FILE.new ]; then
    rm -f $BLOGS_FILE.new
fi

cat $TEMPFILE_BASE | grep "ZeroNet Blog\|hostname =\|address =\|port =\|txt-record =" > $TEMPFILE

state=0
address=""
peer=""
while IFS='' read -r line || [[ -n "$line" ]]; do
    if [ ${state} -eq "3" ]; then
        if [[ $line == *"txt-record ="* ]]; then
            blog_url=$(echo $line | awk -F '[' '{print $2}' | awk -F ']' '{print $1}')
            echo "$peer $blog_url" >> $BLOGS_FILE.new
            state=0
        fi
    fi
    if [ ${state} -eq "2" ]; then
        if [[ $line == *"address ="* ]]; then
            address=$(echo $line | awk -F '[' '{print $2}' | awk -F ']' '{print $1}')
            state=3
        fi
    fi
    if [ ${state} -eq "1" ]; then
        if [[ $line == *"hostname ="* ]]; then
            peer=$(echo $line | awk -F '[' '{print $2}' | awk -F ']' '{print $1}')
            state=2
        fi
    fi
    if [[ $line == *"ZeroNet Blog"* && $line == "= "* ]]; then
        state=1
    fi
done < "$TEMPFILE"

# detect fora in the mesh
if [ -f $FORUM_FILE.new ]; then
    rm -f $FORUM_FILE.new
fi

cat $TEMPFILE_BASE | grep "ZeroNet Forum\|hostname =\|address =\|port =\|txt-record =" > $TEMPFILE

state=0
address=""
peer=""
while IFS='' read -r line || [[ -n "$line" ]]; do
    if [ ${state} -eq "3" ]; then
        if [[ $line == *"txt-record ="* ]]; then
            forum_url=$(echo $line | awk -F '[' '{print $2}' | awk -F ']' '{print $1}')
            echo "$peer $forum_url" >> $FORUM_FILE.new
            state=0
        fi
    fi
    if [ ${state} -eq "2" ]; then
        if [[ $line == *"address ="* ]]; then
            address=$(echo $line | awk -F '[' '{print $2}' | awk -F ']' '{print $1}')
            state=3
        fi
    fi
    if [ ${state} -eq "1" ]; then
        if [[ $line == *"hostname ="* ]]; then
            peer=$(echo $line | awk -F '[' '{print $2}' | awk -F ']' '{print $1}')
            state=2
        fi
    fi
    if [[ $line == *"ZeroNet Forum"* && $line == "= "* ]]; then
        state=1
    fi
done < "$TEMPFILE"

rm -f $TEMPFILE_BASE
rm -f $TEMPFILE

cp -f $BOOTSTRAP_FILE.new $BOOTSTRAP_FILE
rm -f $BOOTSTRAP_FILE.new
if [ -d /home/zeronet ]; then
    sudo chown zeronet:zeronet $BOOTSTRAP_FILE
fi

cp -f $BLOGS_FILE.new $BLOGS_FILE
rm -f $BLOGS_FILE.new
if [ -d /home/zeronet ]; then
    sudo chown zeronet:zeronet $BLOGS_FILE
fi

cp -f $FORUM_FILE.new $FORUM_FILE
rm -f $FORUM_FILE.new
if [ -d /home/zeronet ]; then
    sudo chown zeronet:zeronet $FORUM_FILE
fi

exit 0
